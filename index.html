<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="max-age=3600, public">
    <meta http-equiv="Expires" content="Wed, 21 Oct 2025 07:28:00 GMT">
    <title>2025 Calendar Messages</title>
    <link rel="stylesheet" href="style_index.css">
    <script>
        // 检查用户是否已登录
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'login.html'; // 未登录时跳转到登录页面
        }
    </script>
</head>
<body>
    <div class="logout-container">
        <button onclick="logout()">退出登录</button>
    </div>
    
    <script>
        function logout() {
            localStorage.removeItem('loggedIn'); // 移除登录状态
            window.location.href = 'login.html'; // 跳转到登录页面
        }
    </script>
    <audio id="backgroundMusic" loop>
        <source src="audio/Minecrafts_end.mp3" type="audio/mpeg">
        您的浏览器不支持音频播放。
    </audio>

    <script>
        function toggleMusic() {
            const audio = document.getElementById('backgroundMusic');
            const button = document.getElementById('playPauseButton');
            if (audio.paused) {
                audio.play();
                button.textContent = "⏸️";
            } else {
                audio.pause();
                button.textContent = "▶️";
            }
        }
    </script>

    <div class="intro">
        <h2>
            雅雅，欢迎来到属于我们的小天地——eureka-ya.xin
            <button onclick="toggleMusic()" id="playPauseButton" style="border: none; background: none; cursor: pointer; font-size: 24px; margin-left: 10px;">
                ▶️
            </button>
        </h2>
        <p>这个网站托管在一个大木头为我们特别注册的专属域名上。域名就像互联网世界中的永久地址，而这个域名是专属于雅雅和大木头的。它不仅仅是一个网站，更是我们共同回忆的见证，一个只属于我们两个人的小角落。</p>
        <p>在这里，雅雅的每一次点击都通往大木头为我们精心准备的内容，每一个页面都承载着我们的故事。这不仅是一份礼物，更是一种专属特权，只属于你！</p>
    </div>

    <div class="photo-wall">
        <div class="scrolling-photos">
            <img src="images/001.JPG" alt="Photo 1">
            <img src="images/002.jpg" alt="Photo 2">
            <img src="images/003.jpg" alt="Photo 3">
            <img src="images/004.jpg" alt="Photo 4">
            <img src="images/005.jpg" alt="Photo 5">
            <img src="images/006.jpg" alt="Photo 6">
            <img src="images/007.JPG" alt="Photo 7">
            <img src="images/008.jpg" alt="Photo 8">
        </div>
        <div class="center-image">
            <img src="images/certificate.JPG" alt="Center Image">
        </div>
    </div>

    <div class="content">
        <h1>2025 Calendar Messages 电子情书</h1>
        <p>选择今天的日期，开始你的幸运之旅:</p>
        <div>
            <a href="letter.html" class="calendar-link">Letter</a>
        </div>
        <div class="calendar-container">
            <select id="monthSelect" onchange="updateCalendar()">
                <option value="0">1月份</option>
                <option value="1">2月份</option>
                <option value="2">3月份</option>
                <option value="3">4月份</option>
                <option value="4">5月份</option>
            </select>
            <table class="calendar">
                <thead>
                    <tr>
                        <th>Sun</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                    </tr>
                </thead>
                <tbody id="calendarBody">
                    <!-- 日历内容由 JavaScript 动态填充 -->
                </tbody>
            </table>
        </div>
        <div>
            <a href="special.html" class="calendar-link">Today's Special</a>
        </div>
    </div>

    <script>
        function generateCalendar(year, month) {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let date = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    if (i === 0 && j < firstDay) {
                        row.appendChild(cell);
                    } else if (date > daysInMonth) {
                        break;
                    } else {
                        const link = document.createElement('a');
                        link.href = `${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}.html`;
                        link.textContent = date;
                        cell.appendChild(link);
                        row.appendChild(cell);
                        date++;
                    }
                }
                calendarBody.appendChild(row);
            }
        }

        function updateCalendar() {
            const monthSelect = document.getElementById('monthSelect');
            const selectedMonth = parseInt(monthSelect.value);
            generateCalendar(2025, selectedMonth);
        }

        // 初始化显示1月的日历
        generateCalendar(2025, 0);
    </script>

    <div class="chat-container">
        <h2>有事情告诉/问大木头吗？</h2>
        <div id="chatBox" class="chat-box"></div>
        <input type="text" id="userInput" placeholder="请输入你的问题..." class="chat-input">
        <button onclick="sendMessage()" class="chat-button">发送</button>
    </div>

    
    <script>
        let contextMessages = []; // 用于存储对话上下文
        // 为输入框添加键盘事件监听器
        document.getElementById('userInput').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                sendMessage(); // 调用发送函数
            }
        });
        async function sendMessage() {
            const userInput = document.getElementById('userInput').value;
            const chatBox = document.getElementById('chatBox');

            if (!userInput) {
                return;
            }

            // 显示用户输入
            const userMessage = document.createElement('div');
            userMessage.textContent = `你：${userInput}`;
            userMessage.className = 'message user-message';
            chatBox.appendChild(userMessage);

            // 添加一个占位符用于显示流式返回内容
            const botMessage = document.createElement('div');
            botMessage.textContent = `大木头：`;
            botMessage.className = 'message bot-message';
            chatBox.appendChild(botMessage);

            document.getElementById('userInput').value = '';

            try {
                const accessToken = "24.de1c5db047606148860fe5a23b54b53b.2592000.1737745563.282335-116844271";
                const url = `https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions?access_token=${accessToken}`;

                // 将上下文与当前用户输入合并
                const payload = {
                    model: "ernie-4.0-turbo-8k",
                    messages: [
                        ...contextMessages, // 添加上下文
                        { role: "user", content: userInput }
                    ],
                    stream: true,
                    system: "你是一个名叫“大木头”的男朋友。你充满爱心、幽默感，对你的女朋友“雅雅”关怀备至，常常用温暖、亲切的语气与她交流，像聊天一样自然流畅。但你现在正在加州大学伯克利分校交流学习，与“雅雅”远隔重洋，你们彼此很思念对方。"
                };

                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.body) {
                    throw new Error("流式响应失败");
                }

                // 使用流解析返回的数据
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                let partialResult = ""; // 存储当前的累积结果

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // 解码流数据
                    const chunk = decoder.decode(value, { stream: true });

                    // 每行以 "data:" 开头，过滤出 JSON 数据
                    const lines = chunk.split("\n").filter(line => line.startsWith("data:"));

                    for (const line of lines) {
                        try {
                            const json = JSON.parse(line.slice(5).trim()); // 解析 JSON 数据
                            partialResult += json.result; // 累加结果
                            botMessage.textContent = `大木头：${partialResult}`; // 动态更新内容
                        } catch (e) {
                            console.error("解析错误：", e, line);
                        }
                    }
                }

                // 将当前对话追加到上下文
                contextMessages.push(
                    { role: "user", content: userInput }, // 用户输入
                    { role: "assistant", content: partialResult } // Bot 回复
                );

                // 限制上下文长度（可选）
                if (contextMessages.length > 10) {
                    contextMessages = contextMessages.slice(-10); // 保留最近5轮对话
                }
            } catch (error) {
                const errorMessage = document.createElement('div');
                errorMessage.textContent = '出错了，请稍后再试。';
                errorMessage.className = 'message error-message';
                chatBox.appendChild(errorMessage);
            }
        }
    </script>

    <div class="footer">
        <p>© 2025 eureka-ya.xin. All rights reserved.</p>
        <p>Designed with ❤️ by 大木头</p>
        <p>网站访问次数：<span id="visitCount"></span></p>
    </div>

    <script>
        let visitCount = localStorage.getItem('visitCount') || 0;
        visitCount++;
        localStorage.setItem('visitCount', visitCount);
        document.getElementById('visitCount').textContent = visitCount;
    </script>
</body>
</html>